var Pomelo=function(e){function t(e){return e?r(e):void 0}function r(e){for(var r in t.prototype)e[r]=t.prototype[r];return e}function n(e){return 127>=e?[e]:2047>=e?[192|e>>6,128|63&e]:[224|e>>12,128|(4032&e)>>6,128|63&e]}function o(e){return 127>=e?1:2047>=e?2:3}function a(e,t){if(!t)return!1;for(var r in t){var n=t[r];switch(n.option){case"required":if("undefined"==typeof e[r])return!1;break;case"optional":"undefined"!=typeof e[r]&&t.__messages[n.type]&&a(e[r],t.__messages[n.type]);break;case"repeated":if(e[r]&&t.__messages[n.type])for(var o=0;o<e[r].length;o++)if(!a(e[r][o],t.__messages[n.type]))return!1}}return!0}function s(e,t,r,n){for(var o in n)if(r[o]){var a=r[o];switch(a.option){case"required":case"optional":t=u(e,t,h(a.type,a.tag)),t=i(n[o],a.type,t,e,r);break;case"repeated":n[o].length>0&&(t=c(n[o],a,t,e,r))}}return t}function i(e,t,r,n,o){var a=M.codec;switch(t){case"uInt32":r=u(n,r,a.encodeUInt32(e));break;case"int32":case"sInt32":r=u(n,r,a.encodeSInt32(e));break;case"float":u(n,r,a.encodeFloat(e)),r+=4;break;case"double":u(n,r,a.encodeDouble(e)),r+=8;break;case"string":var i=a.byteLength(e);r=u(n,r,a.encodeUInt32(i)),a.encodeStr(n,r,e),r+=i;break;default:if(o.__messages[t]){var c=new ArrayBuffer(a.byteLength(JSON.stringify(e))),i=0;i=s(c,i,o.__messages[t],e),r=u(n,r,a.encodeUInt32(i));for(var h=0;i>h;h++)n[r]=c[h],r++}}return r}function c(e,t,r,n,o){var a=0;if(util.isSimpleType(t.type))for(r=u(n,r,h(t.type,t.tag)),r=u(n,r,M.codec.encodeUInt32(e.length)),a=0;a<e.length;a++)r=i(e[a],t.type,r,n);else for(a=0;a<e.length;a++)r=u(n,r,h(t.type,t.tag)),r=i(e[a],t.type,r,n,o);return r}function u(e,t,r){for(var n=0;n<r.length;n++,t++)e[t]=r[n];return t}function h(e,t){var r=M.constants.TYPES[e]||2;return M.codec.encodeUInt32(t<<3|r)}function l(e,t,r){for(;J.offset<r;){var n=f(),o=(n.type,n.tag),a=t.__tags[o];switch(t[a].option){case"optional":case"required":e[a]=d(t[a].type,t);break;case"repeated":e[a]||(e[a]=[]),b(e[a],t[a].type,t)}}return e}function f(){var e=M.codec.decodeUInt32(p());return{type:7&e,tag:e>>3}}function d(e,t){var r=M.codec;switch(e){case"uInt32":return r.decodeUInt32(p());case"int32":case"sInt32":return r.decodeSInt32(p());case"float":var n=r.decodeFloat(J.buffer,J.offset);return J.offset+=4,n;case"double":var o=r.decodeDouble(J.buffer,J.offset);return J.offset+=8,o;case"string":var a=r.decodeUInt32(p()),s=r.decodeStr(J.buffer,J.offset,a);return J.offset+=a,s;default:if(t&&t.__messages[e]){var a=r.decodeUInt32(p()),i={};return l(i,t.__messages[e],J.offset+a),i}}}function b(e,t,r){if(K.isSimpleType(t))for(var n=M.codec.decodeUInt32(p()),o=0;n>o;o++)e.push(d(t));else e.push(d(t,r))}function p(e){var t=[],r=J.offset;e=e||!1;var n;do n=B[r],t.push(n),r++;while(n>=128);return e||(J.offset=r),t}var v=function(){return egret.Capabilities.runtimeType==egret.RuntimeType.NATIVE?__global.egret_native.WebSocket:window.WebSocket}();t.prototype.on=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks[e]=this._callbacks[e]||[]).push(t),this},t.prototype.once=function(e,t){function r(){n.off(e,r),t.apply(this,arguments)}var n=this;return this._callbacks=this._callbacks||{},t._off=r,this.on(e,r),this},t.prototype.off=t.prototype.removeListener=t.prototype.removeAllListeners=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var r=this._callbacks[e];if(!r)return this;if(1==arguments.length)return delete this._callbacks[e],this;var n=index(r,t._off||t);return~n&&r.splice(n,1),this},t.prototype.emit=function(e){this._callbacks=this._callbacks||{};var t=[].slice.call(arguments,1),r=this._callbacks[e];if(r){r=r.slice(0);for(var n=0,o=r.length;o>n;++n)r[n].apply(this,t)}return this},t.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks[e]||[]},t.prototype.hasListeners=function(e){return!!this.listeners(e).length};var g=4,y=1,k=2,T=1,m=65535,_=1,I=7,E={Package:{TYPE_HANDSHAKE:1,TYPE_HANDSHAKE_ACK:2,TYPE_HEARTBEAT:3,TYPE_DATA:4,TYPE_KICK:5},Message:{TYPE_REQUEST:0,TYPE_NOTIFY:1,TYPE_RESPONSE:2,TYPE_PUSH:3}},w=E.Package,P=E.Message;E.strencode=function(t){for(var r=new e(3*t.length),n=0,o=0;o<t.length;o++){var a=t.charCodeAt(o),s=null;s=127>=a?[a]:2047>=a?[192|a>>6,128|63&a]:[224|a>>12,128|(4032&a)>>6,128|63&a];for(var i=0;i<s.length;i++)r[n]=s[i],++n}var c=new e(n);return S(c,0,r,0,n),c},E.strdecode=function(t){for(var r=new e(t),n=[],o=0,a=0,s=r.length;s>o;)r[o]<128?(a=r[o],o+=1):r[o]<224?(a=((63&r[o])<<6)+(63&r[o+1]),o+=2):(a=((15&r[o])<<12)+((63&r[o+1])<<6)+(63&r[o+2]),o+=3),n.push(a);return String.fromCharCode.apply(null,n)},w.encode=function(t,r){var n=r?r.length:0,o=new e(g+n),a=0;return o[a++]=255&t,o[a++]=n>>16&255,o[a++]=n>>8&255,o[a++]=255&n,r&&S(o,a,r,0,n),o},w.decode=function(t){var r=new e(t),n=r[0],o=1,a=(r[o++]<<16|r[o++]<<8|r[o++])>>>0,s=a?new e(a):null;return S(s,0,r,g,a),{type:n,body:s}},P.encode=function(t,r,n,o,a){var s=A(r)?Y(t):0,i=y+s;if(C(r))if(n){if("number"!=typeof o)throw new Error("error flag for number route!");i+=k}else if(i+=T,o){if(o=E.strencode(o),o.length>255)throw new Error("route maxlength is overflow");i+=o.length}a&&(i+=a.length);var c=new e(i),u=0;return u=U(r,n,c,u),A(r)&&(u=N(t,s,c,u)),C(r)&&(u=H(n,o,c,u)),a&&(u=D(a,c,u)),c},P.decode=function(t){var r=new e(t),n=r.length||r.byteLength,o=0,a=0,s=null,i=r[o++],c=i&_,u=i>>1&I;if(A(u)){var h=r[o++];for(a=127&h;128&h;)a<<=7,h=r[o++],a|=127&h}if(C(u))if(c)s=r[o++]<<8|r[o++];else{var l=r[o++];l?(s=new e(l),S(s,0,r,o,l),s=E.strdecode(s)):s="",o+=l}var f=n-o,d=new e(f);return S(d,0,r,o,f),{id:a,type:u,compressRoute:c,route:s,body:d}};var S=function(e,t,r,n,o){if("function"==typeof r.copy)r.copy(e,t,n,n+o);else for(var a=0;o>a;a++)e[t++]=r[n++]},A=function(e){return e===P.TYPE_REQUEST||e===P.TYPE_RESPONSE},C=function(e){return e===P.TYPE_REQUEST||e===P.TYPE_NOTIFY||e===P.TYPE_PUSH},Y=function(e){var t=0;do t+=1,e>>=7;while(e>0);return t},U=function(e,t,r,n){if(e!==P.TYPE_REQUEST&&e!==P.TYPE_NOTIFY&&e!==P.TYPE_RESPONSE&&e!==P.TYPE_PUSH)throw new Error("unkonw message type: "+e);return r[n]=e<<1|(t?1:0),n+y},N=function(e,t,r,n){var o=n+t-1;for(r[o--]=127&e;o>=n;)e>>=7,r[o--]=127&e|128;return n+t},H=function(e,t,r,n){if(e){if(t>m)throw new Error("route number is overflow");r[n++]=t>>8&255,r[n++]=255&t}else t?(r[n++]=255&t.length,S(r,n,t,0,t.length),n+=t.length):r[n++]=0;return n},D=function(e,t,r){return S(t,r,e,0,e.length),r+e.length},M={};M.init=function(e){M.encoder.init(e.encoderProtos),M.decoder.init(e.decoderProtos)},M.encode=function(e,t){return M.encoder.encode(e,t)},M.decode=function(e,t){return M.decoder.decode(e,t)};var R={};R.TYPES={uInt32:0,sInt32:0,int32:0,"double":1,string:2,message:2,"float":5};var K={};K.isSimpleType=function(e){return"uInt32"===e||"sInt32"===e||"int32"===e||"uInt64"===e||"sInt64"===e||"float"===e||"double"===e};var O={},B=new ArrayBuffer(8),q=new Float32Array(B),F=new Float64Array(B),L=new Uint8Array(B);O.encodeUInt32=function(e){var e=parseInt(e);if(isNaN(e)||0>e)return null;var t=[];do{var r=e%128,n=Math.floor(e/128);0!==n&&(r+=128),t.push(r),e=n}while(0!==e);return t},O.encodeSInt32=function(e){var e=parseInt(e);return isNaN(e)?null:(e=0>e?2*Math.abs(e)-1:2*e,O.encodeUInt32(e))},O.decodeUInt32=function(e){for(var t=0,r=0;r<e.length;r++){var n=parseInt(e[r]);if(t+=(127&n)*Math.pow(2,7*r),128>n)return t}return t},O.decodeSInt32=function(e){var t=this.decodeUInt32(e),r=t%2===1?-1:1;return t=(t%2+t)/2*r},O.encodeFloat=function(e){return q[0]=e,L},O.decodeFloat=function(e,t){if(!e||e.length<t+4)return null;for(var r=0;4>r;r++)L[r]=e[t+r];return q[0]},O.encodeDouble=function(e){return F[0]=e,L.subarray(0,8)},O.decodeDouble=function(e,t){if(!e||e.length<8+t)return null;for(var r=0;8>r;r++)L[r]=e[t+r];return F[0]},O.encodeStr=function(e,t,r){for(var o=0;o<r.length;o++)for(var a=r.charCodeAt(o),s=n(a),i=0;i<s.length;i++)e[t]=s[i],t++;return t},O.decodeStr=function(e,t,r){for(var n=[],o=t+r;o>t;){var a=0;e[t]<128?(a=e[t],t+=1):e[t]<224?(a=((63&e[t])<<6)+(63&e[t+1]),t+=2):(a=((15&e[t])<<12)+((63&e[t+1])<<6)+(63&e[t+2]),t+=3),n.push(a)}for(var s="",i=0;i<n.length;)s+=String.fromCharCode.apply(null,n.slice(i,i+1e4)),i+=1e4;return s},O.byteLength=function(e){if("string"!=typeof e)return-1;for(var t=0,r=0;r<e.length;r++){var n=e.charCodeAt(r);t+=o(n)}return t};var x=M.encoder={};x.init=function(e){this.protos=e||{}},x.encode=function(e,t){var r=this.protos[e];if(!a(t,r))return null;var n=M.codec.byteLength(JSON.stringify(t)),o=new ArrayBuffer(n),i=new Uint8Array(o),c=0;return r&&(c=s(i,c,r,t),c>0)?i.subarray(0,c):null};var J=M.decoder={};J.buffer=0,J.offset=0,J.init=function(e){this.protos=e||{}},J.setProtos=function(e){e&&(this.protos=e)},J.decode=function(e,t){var r=this.protos[e];return J.buffer=t,J.offset=0,r?l({},r,B.length):null};var Q="js-websocket",W="0.0.5",V=200,j=501,z=function(){this.socket=null,this.callbacks={},this.handlers={},this.routeMap={},this.heartbeatInterval=0,this.heartbeatTimeout=0,this.nextHeartbeatTimeout=0,this.gapThreshold=100,this.heartbeatId=null,this.heartbeatTimeoutId=null,this.handshakeCallback=null,this.handshakeBuffer={sys:{type:Q,version:W},user:{}},this.initCallback=null,this.handlers[w.TYPE_HANDSHAKE]=this.handshake,this.handlers[w.TYPE_HEARTBEAT]=this.heartbeat,this.handlers[w.TYPE_DATA]=this.onData,this.handlers[w.TYPE_KICK]=this.onKick};z.reqId=120;var G=z.prototype;r(G),G.init=function(e,t,r,n,o,a){this.initCallback=r,this.thisArgs=a,this.errorCallback=n,this.closeCallBack=o;var s=e.host,i=e.port,c="ws://"+s;1==t&&(c="wss://"+s),i&&(c+=":"+i),this.handshakeBuffer.user=e.user,this.handshakeCallback=e.handshakeCallback,this.initWebSocket(c,r)},G.initWebSocket=function(e,t){console.log("connect to "+e);var r=this,n=function(e){var t=w.encode(w.TYPE_HANDSHAKE,E.strencode(JSON.stringify(r.handshakeBuffer)));r.send(t)},o=function(e){r.processPackage(w.decode(e.data),t),r.heartbeatTimeout&&(r.nextHeartbeatTimeout=Date.now()+r.heartbeatTimeout)},a=function(e){r.processPackage(w.decode(e),t),r.heartbeatTimeout&&(r.nextHeartbeatTimeout=Date.now()+r.heartbeatTimeout)},s=function(e){r.emit("io-error",e),console.error("socket error: ",e),r.errorCallback&&r.errorCallback.apply(r.thisArgs,e)},i=function(e){r.emit("close",e),console.error("socket close: ",e),r.closeCallBack&&r.closeCallBack.apply(r.thisArgs,e)};this.socket=new v(e),egret.Capabilities.runtimeType==egret.RuntimeType.NATIVE?(this.socket.onOpen=n,this.socket.onMessage=a,this.socket.onError=s,this.socket.onClose=i):(this.socket.binaryType="arraybuffer",this.socket.onopen=n,this.socket.onmessage=o,this.socket.onerror=s,this.socket.onclose=i)},G.disconnect=function(){var e=this.socket;e&&(e.disconnect&&e.disconnect(),e.close&&e.close(),console.log("disconnect"),this.socket=null),this.heartbeatId&&(clearTimeout(this.heartbeatId),this.heartbeatId=null),this.heartbeatTimeoutId&&(clearTimeout(this.heartbeatTimeoutId),this.heartbeatTimeoutId=null),this.initCallback=null,this.thisArgs=null,this.errorCallback=null,this.closeCallBack=null},G.request=function(e,t,r){2===arguments.length&&"function"==typeof t?(r=t,t={}):t=t||{},e=e||t.route,e&&(z.reqId++,128==z.reqId&&(z.reqId=1),this.sendMessage(z.reqId,e,t),this.callbacks[z.reqId]=r,this.routeMap[z.reqId]=e)},G.notify=function(e,t){t=t||{},this.sendMessage(0,e,t)},G.sendMessage=function(e,t,r){var n=e?P.TYPE_REQUEST:P.TYPE_NOTIFY,o=this.data.protos?this.data.protos.client:{};r=o[t]?M.encode(t,r):E.strencode(JSON.stringify(r));var a=0;this.dict&&this.dict[t]&&(t=this.dict[t],a=1),r=P.encode(e,n,a,t,r);var s=w.encode(w.TYPE_DATA,r);this.send(s)},G.send=function(e){this.socket.send(e.buffer)},G.heartbeat=function(e){if(this.heartbeatInterval){var t=w.encode(w.TYPE_HEARTBEAT);if(this.heartbeatTimeoutId&&(clearTimeout(this.heartbeatTimeoutId),this.heartbeatTimeoutId=null),!this.heartbeatId){var r=this;this.heartbeatId=setTimeout(function(){r.heartbeatId=null,r.send(t),r.nextHeartbeatTimeout=Date.now()+r.heartbeatTimeout,r.heartbeatTimeoutId=setTimeout(r.heartbeatTimeoutCb.bind(r),r.heartbeatTimeout)},this.heartbeatInterval)}}},G.heartbeatTimeoutCb=function(){var e=this.nextHeartbeatTimeout-Date.now();e>this.gapThreshold?this.heartbeatTimeoutId=setTimeout(this.heartbeatTimeoutCb.bind(this),e):(console.error("server heartbeat timeout"),this.emit("heartbeat_timeout"),this.disconnect())},G.handshake=function(e){if(e=JSON.parse(E.strdecode(e)),e.code===j)return void this.emit("error","client version not fullfill");if(e.code!==V)return void this.emit("error","handshake fail");this.handshakeInit(e);var t=w.encode(w.TYPE_HANDSHAKE_ACK);this.send(t),this.initCallback&&(this.initCallback.apply(this.thisArgs,e),this.initCallback=null)},G.onData=function(e){var t=P.decode(e);t.id>0&&(t.route=this.routeMap[t.id],delete this.routeMap[t.id],!t.route)||(t.body=this.deCompose(t),this.processMessage(G,t))},G.onKick=function(e){this.emit("onKick")},G.processPackage=function(e){this.handlers[e.type].apply(this,[e.body])},G.processMessage=function(e,t){if(!t.id)return void this.emit("server_push_message",t);var r=this.callbacks[t.id];delete this.callbacks[t.id],"function"==typeof r&&r(t.body)};return G.deCompose=function(e){var t=this.data.protos?this.data.protos.server:{},r=this.data.abbrs,n=e.route;if(e.compressRoute){if(!r[n])return{};n=e.route=r[n]}return t[n]?M.decode(n,e.body):JSON.parse(E.strdecode(e.body))},G.handshakeInit=function(e){e.sys&&e.sys.heartbeat?(this.heartbeatInterval=1e3*e.sys.heartbeat,this.heartbeatTimeout=2*this.heartbeatInterval):(this.heartbeatInterval=0,this.heartbeatTimeout=0),this.initData(e),"function"==typeof this.handshakeCallback&&this.handshakeCallback(e.user)},G.initData=function(e){if(e&&e.sys){this.data=e||{};var t=e.sys.dict,r=e.sys.protos;if(t){e.dict=t,e.abbrs={};for(var n in t)e.abbrs[t[n]]=n}r&&(e.protos={server:r.server||{},client:r.client||{}},this.protobuf&&this.protobuf.init({encoderProtos:r.client,decoderProtos:r.server}))}},z}(Uint8Array);